<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/stairs.css">
    <script src="../js/three.min.js"></script>
    <script src="../js/OrbitControls.js"></script>
</head>
<body>
    <div class="box">
        <h2 class="header">
            <span>楼梯拆分参数设置</span>
        </h2>
        <div class="form">
            <form action="" id="form1">
                <label for="first">拼缝1</label>
                <input type="text" id="first" class="pingfeng" value="20">
                <label for="second">拼缝2</label>
                <input type="text" id="second" class="pingfeng" value="20">
                <label for="third">拼缝3</label>
                <input type="text" id="third" class="pingfeng" value="20">
                <label for="forth">拼缝4</label>
                <input type="text" id="forth" class="pingfeng" value="20">
                <label for="fifth">拼缝5</label>
                <input type="text" id="fifth" class="pingfeng" value="30">
                <label for="six">拼缝6</label>
                <input type="text" id="six" class="pingfeng" value="20">
            </form>
            <form action="" id=form2>
                <div class="stairs">
                    楼梯总高度：<input type="text" class="stairs" value="2900">
                    台阶数：<input type="text" class="stairs" value="17">
                </div>
                <div class="bench">
                    板厚：<input type="text" class="bench" value="180">
                    上水平梯段厚度：<input type="text" class="bench" value="180">
                    下水平梯段厚度：<input type="text" class="bench" value="180">
                    上水平梯段宽度：<input type="text" class="bench" value="500">
                    下水平梯段宽度：<input type="text" class="bench" value="500">
                </div>
                <div class="ladderBeam">
                    梁宽：<input type="text" class="ladderBeam" value="200">
                    梁高：<input type="text" class="ladderBeam" value="400">
                    挑耳宽：<input type="text" class="ladderBeam" value="200">
                    挑耳高：<input type="text" class="ladderBeam" value="200">
                    下沉高度：<input type="text" class="ladderBeam" value="200">
                </div>
            </form>
        </div>
        <div class="btn">
            <input type="button" value="取消" class="cancel">
            <input type="button" value="应用" class="confirm">
        </div>
    </div>


    <script type="module">
        import common from '../js/common.js'
        import {Stairs} from '../js/object.js'
        let s=new Stairs()
      
        // 楼梯
        const stairs={
            num:17,
            totalWidth:4420,
            totalHeight:2900,
            width:260,
            height:161,
            depth:1400
        }
        // 梯梁
        const ladderBeam={
            beamWidth:200,
            beamHeight:400,
            tiaoerWidth:200,
            tiaoerHeight:200,
            sinkHeight:200
        }
        // 梯段
        const bench={
            h:180,
            fh:180,
            fw:500,
            uw:500,
            uh:180
        }
        // 拼缝
        const feng={
            f1:20,
            f2:20,
            f3:20,
            f4:20,
            f5:30,
            f6:20
        }

        let box=$('.box')
        let flag=false
        let scene,camera,renderer
        let mesh,mesh2,mesh3,mesh4

        beforeBreak()
        renderer=new THREE.WebGLRenderer()
        common.initLight(scene)
        camera=common.initCamera(scene)
        common.initRenderer(renderer)
        render()

        let controls = new THREE.OrbitControls(camera, renderer.domElement)
        controls.addEventListener('change',render)

        document.addEventListener('click',function(e){
            let mouse=common.getStdVector(e)
            let raycaster=new THREE.Raycaster()
            raycaster.setFromCamera(mouse,camera)
            let intersects=raycaster.intersectObjects(scene.children,true)
            if(intersects.length>0){
                box[0].style.visibility='visible'
            }
        })
        $('.cancel')[0].addEventListener('click',function(e){
            e.stopPropagation()
            box[0].style.visibility='hidden'
            flag=false
        })
        $('.confirm')[0].addEventListener('click',function(e){
            e.stopPropagation()
            box[0].style.visibility='hidden'

            if(!flag){
                initPingfeng()
            }
            initValue()
            $('#form2').style.display='block'
            editStairs(stairs,bench)

            
        })
        
        function render() {
            renderer.render(scene,camera)
            requestAnimationFrame(render)
        }
        function beforeBreak(){
            let stairsVertices=createStairsVertices(stairs)
            let geometry=createGeometry(stairsVertices,stairs.depth)
            let material=new THREE.MeshLambertMaterial({
                color:0xff0000,
                side:THREE.DoubleSide
            })
            mesh=new THREE.Mesh(geometry,material)
            let geometry2=new THREE.BoxGeometry(200,400,2900)
            geometry2.translate(stairs.num*stairs.width+100,stairs.num*stairs.height,2900/2)
            let material2=new THREE.MeshLambertMaterial({
                color:0x00ff00,
            })
            mesh2=new THREE.Mesh(geometry2,material2)
            scene=new THREE.Scene()
            scene.add(mesh,mesh2)

            let axes=new THREE.AxesHelper(8000)
            scene.add(axes)

            let geometry3=geometry.clone()
            mesh3=new THREE.Mesh(geometry3,material)
            mesh3.rotateY(Math.PI)
            let geometry4=geometry2.clone()
            mesh4=new THREE.Mesh(geometry4,material2)
            mesh4.rotateY(Math.PI)
            // scene.add(mesh3,mesh4)

            let group=new THREE.Group()
            group.add(mesh3,mesh4)
            group.translateZ(100+stairs.depth*2)
            group.translateX(12*260)
            scene.add(group)
        }
        function afterBreak(){
            initPingfeng()
        }
        function initPingfeng(){
            let pingfeng=$('.pingfeng')
            for(let i=0;i<pingfeng.length;i++){
                feng['f'+(i+1)]=Number(pingfeng[i].value)
            }
            
            editStairs(stairs,bench)
            mesh.position.set(0,0,feng.f4)           
            mesh3.position.set(0,0,-feng.f1)

            let ladderBeamVertice=createLadderBeamVertices(stairs,bench,ladderBeam,feng)
            mesh2.geometry.dispose()
            mesh2.geometry=createGeometry(ladderBeamVertice,stairs.depth) 
            $('#form1').style.display='none'
            flag=true
        }

        function editStairs(stairs,bench){
            mesh.geometry.dispose()
            let stairsVertices=createStairsVertices(stairs)
            let benchVertices=createBenchVertices(stairs,bench)
            stairsVertices.shift()
            stairsVertices.unshift(...benchVertices[0])
            stairsVertices.push(...benchVertices[1])
            // console.log(stairsVertices)
            mesh.geometry=createGeometry(stairsVertices,stairs.depth-feng.f3-feng.f4)
            mesh3.geometry.dispose()
            mesh3.geometry=createGeometry(stairsVertices,stairs.depth-feng.f1-feng.f2) 
        }
        // function createStairsVertices(stairs) {
        //     let vertices=[]
        //     stairs.width=stairs.totalWidth/stairs.num
        //     stairs.height=stairs.totalHeight/stairs.num
        //     for(let i=0;i<stairs.num;i++){
        //         let vector1=new THREE.Vector2(i*stairs.width,i*stairs.height)
        //         let vector2=new THREE.Vector2(i*stairs.width,(i+1)*stairs.height)
        //         vertices.push(vector1)
        //         vertices.push(vector2)
        //     }
        //     vertices.push(new THREE.Vector2(stairs.num*stairs.width,stairs.num*stairs.height))

        //     vertices.push(new THREE.Vector2(stairs.num*stairs.width,stairs.num*stairs.height-200))
        //     vertices.unshift(new THREE.Vector2(0,-200))
        //     // console.log(vertices)
        //     return vertices
        // }
        // function createBenchVertices(stairs,bench) {
        //     let vertices=[],upVertice=[],underVertice=[]
        //     let k=stairs.height/stairs.width // 161/260
        //     // y=k*x-h
        //     underVertice.push(new THREE.Vector2((-bench.uh+bench.h)/k,-bench.uh))
        //     underVertice.push(new THREE.Vector2(-bench.uw,-bench.uh),new THREE.Vector2(-bench.uw,0))

        //     upVertice.push(new THREE.Vector2(stairs.totalWidth,stairs.totalHeight+bench.fh),new THREE.Vector2(stairs.totalWidth+bench.fw,stairs.totalHeight+bench.fh))
        //     upVertice.push(new THREE.Vector2(stairs.totalWidth+bench.fw,stairs.totalHeight))
        //     upVertice.push(new THREE.Vector2((stairs.totalHeight+bench.h)/k,stairs.totalHeight))
        //     vertices.push(underVertice,upVertice)
        //     // console.log(vertices)
        //     return vertices
        // }
        // function createLadderBeamVertices(stairs,bench,ladderBeam,feng) {
        //     let  vertices=[]
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5,stairs.totalHeight+bench.fh))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5+ladderBeam.beamWidth,stairs.totalHeight+bench.fh))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5+ladderBeam.beamWidth,stairs.totalHeight+bench.fh-ladderBeam.beamHeight))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5,stairs.totalHeight+bench.fh-ladderBeam.beamHeight))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5-ladderBeam.tiaoerWidth,stairs.totalHeight+bench.fh-ladderBeam.beamHeight))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5-ladderBeam.tiaoerWidth,stairs.totalHeight+bench.fh-ladderBeam.beamHeight+ladderBeam.tiaoerHeight))
        //     vertices.push(new THREE.Vector2(stairs.totalWidth+bench.fw+feng.f5,stairs.totalHeight+bench.fh-ladderBeam.beamHeight+ladderBeam.tiaoerHeight))
        //     console.log(vertices)
        //     return vertices
        // }
        function createGeometry(stairsVertices,depth){
            let shape=new THREE.Shape(stairsVertices)
            let geometry=new THREE.ExtrudeGeometry(shape,{depth:depth}) //stairs.depth-feng.f3-feng.f4
            return geometry
        }
        function $(v){
            let dom
            let name=v.substring(1)
            if(v.indexOf('#')==0){
                dom=document.getElementById(name)
            }else if(v.indexOf('.')==0){
                dom=document.getElementsByClassName(name)
            }else{
                console.log(v)
            }
            return dom
        }
        function initValue(){
            
            stairs.totalHeight=Number($('.stairs')[1].value)
            stairs.num=Number($('.stairs')[2].value)
            console.log(stairs)
            bench.h=Number($('.bench')[1].value)
            bench.fh=Number($('.bench')[2].value)
            bench.uh=Number($('.bench')[3].value)
            bench.fw=Number($('.bench')[4].value)
            bench.uw=Number($('.bench')[5].value)
            // console.log(bench)
            ladderBeam.beamWidth=Number($('.ladderBeam')[1].value)
            ladderBeam.beamHeight=Number($('.ladderBeam')[2].value)
            ladderBeam.tiaoerWidth=Number($('.ladderBeam')[3].value)
            ladderBeam.totalHeight=Number($('.ladderBeam')[4].value)
            ladderBeam.sinkHeight=Number($('.ladderBeam')[5].value)
            // console.log(ladderBeam)
        }
    </script>
</body>
</html>